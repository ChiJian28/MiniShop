<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•é˜²é‡å¤è´­ä¹°é€»è¾‘</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s;
        }
        .btn-primary { background: #ff4000; color: white; }
        .btn-primary:hover { background: #e63600; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status.error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .status.already-purchased { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .status.info { background: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd; }
        .purchase-history {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ›¡ï¸ é˜²é‡å¤è´­ä¹°é€»è¾‘æµ‹è¯•</h1>
    <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•ç”¨æˆ·åªèƒ½è´­ä¹°ä¸€æ¬¡çš„é€»è¾‘</p>

    <div class="test-section">
        <h3>ç”¨æˆ·ä¿¡æ¯</h3>
        <div id="userInfo" class="status info">
            æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...
        </div>
    </div>

    <div class="test-section">
        <h3>å•†å“æµ‹è¯•</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
            <button class="button btn-primary" onclick="testPurchase(1001)">
                è´­ä¹° iPhone (ID: 1001)
            </button>
            <button class="button btn-primary" onclick="testPurchase(1002)">
                è´­ä¹° MacBook (ID: 1002)
            </button>
            <button class="button btn-primary" onclick="testPurchase(1003)">
                è´­ä¹° iPad (ID: 1003)
            </button>
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="button btn-secondary" onclick="showPurchaseHistory()">
                æŸ¥çœ‹è´­ä¹°è®°å½•
            </button>
            <button class="button btn-danger" onclick="clearAllPurchases()">
                æ¸…é™¤æ‰€æœ‰è´­ä¹°è®°å½•
            </button>
            <button class="button btn-success" onclick="clearLog()">
                æ¸…é™¤æ—¥å¿—
            </button>
        </div>
    </div>

    <div class="test-section">
        <h3>è´­ä¹°è®°å½•</h3>
        <div id="purchaseHistory" class="purchase-history">
            ç‚¹å‡»"æŸ¥çœ‹è´­ä¹°è®°å½•"æŒ‰é’®æŸ¥çœ‹å½“å‰è´­ä¹°çŠ¶æ€
        </div>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•ç»“æœ</h3>
        <div id="testResult" class="status info">
            ç‚¹å‡»è´­ä¹°æŒ‰é’®å¼€å§‹æµ‹è¯•
        </div>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•æ—¥å¿—</h3>
        <div id="testLog" class="log">
            ç­‰å¾…æµ‹è¯•æ“ä½œ...
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿè·å–å½“å‰ç”¨æˆ·IDçš„å‡½æ•°ï¼ˆä¸å‰ç«¯ä»£ç ç›¸åŒï¼‰
        function getCurrentUserId() {
            try {
                const authStorage = localStorage.getItem('auth-storage');
                if (authStorage) {
                    const authData = JSON.parse(authStorage);
                    if (authData.state?.user?.id) {
                        return authData.state.user.id;
                    }
                }
            } catch (error) {
                console.warn('Failed to get user ID from auth storage:', error);
            }
            return 1; // é»˜è®¤ç”¨æˆ·ID
        }

        // è®°å½•æ—¥å¿—
        function log(message) {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            document.getElementById('testLog').innerHTML = 'æ—¥å¿—å·²æ¸…é™¤...\n';
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function showUserInfo() {
            const userId = getCurrentUserId();
            document.getElementById('userInfo').innerHTML = `
                å½“å‰ç”¨æˆ·ID: ${userId}<br>
                <small>ç”¨æˆ·IDç”¨äºæ ‡è¯†ä¸åŒç”¨æˆ·çš„è´­ä¹°è®°å½•</small>
            `;
        }

        // æµ‹è¯•è´­ä¹°é€»è¾‘
        async function testPurchase(productId) {
            const userId = getCurrentUserId();
            const purchaseKey = `purchase_${userId}_${productId}`;
            const hasAlreadyPurchased = localStorage.getItem(purchaseKey) === 'true';
            
            log(`å¼€å§‹æµ‹è¯•è´­ä¹° - ç”¨æˆ·: ${userId}, å•†å“: ${productId}`);
            log(`æ£€æŸ¥è´­ä¹°è®°å½•: ${hasAlreadyPurchased ? 'å·²è´­ä¹°' : 'æœªè´­ä¹°'}`);
            
            const resultElement = document.getElementById('testResult');
            
            try {
                // æ¨¡æ‹ŸAPIè°ƒç”¨
                await simulatePurchaseAPI(productId, userId);
            } catch (error) {
                // å¤„ç†é”™è¯¯
                if (error.code === 1002) {
                    // å·²è´­ä¹°é”™è¯¯
                    resultElement.className = 'status already-purchased';
                    resultElement.innerHTML = `
                        <strong>âœ‹ è´­ä¹°å¤±è´¥</strong><br>
                        ${error.message}<br>
                        <small>å•†å“ID: ${productId} | ç”¨æˆ·ID: ${userId}</small>
                    `;
                    log(`è´­ä¹°å¤±è´¥: ${error.message}`);
                } else {
                    // å…¶ä»–é”™è¯¯
                    resultElement.className = 'status error';
                    resultElement.innerHTML = `
                        <strong>âŒ è´­ä¹°å¤±è´¥</strong><br>
                        ${error.message}<br>
                        <small>å•†å“ID: ${productId} | é”™è¯¯ç : ${error.code}</small>
                    `;
                    log(`è´­ä¹°å¤±è´¥: ${error.message} (é”™è¯¯ç : ${error.code})`);
                }
            }
        }

        // æ¨¡æ‹Ÿè´­ä¹°API
        async function simulatePurchaseAPI(productId, userId) {
            const purchaseKey = `purchase_${userId}_${productId}`;
            const hasAlreadyPurchased = localStorage.getItem(purchaseKey) === 'true';
            
            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            
            // å¦‚æœç”¨æˆ·å·²ç»è´­ä¹°è¿‡ï¼Œç›´æ¥è¿”å›å·²è´­ä¹°é”™è¯¯
            if (hasAlreadyPurchased) {
                log('æ£€æµ‹åˆ°é‡å¤è´­ä¹°ï¼Œè¿”å›é”™è¯¯');
                throw {
                    code: 1002,
                    message: 'æ‚¨å·²å‚ä¸è¿‡æ­¤æ¬¡ç§’æ€',
                    reason: 'already_purchased'
                };
            }
            
            // æ¨¡æ‹Ÿä¸åŒçš„å“åº”ç»“æœï¼ˆä¸åŒ…æ‹¬é‡å¤è´­ä¹°ï¼‰
            const mockResponses = [
                { code: 0, message: 'ç§’æ€æˆåŠŸï¼', success: true },
                { code: 1001, message: 'åº“å­˜ä¸è¶³ï¼Œç§’æ€å¤±è´¥', success: false },
                { code: 1003, message: 'ç§’æ€å¤ªç«çˆ†äº†ï¼Œè¯·ç¨åå†è¯•', success: false },
            ];
            
            const randomResponse = mockResponses[Math.floor(Math.random() * mockResponses.length)];
            
            if (randomResponse.code === 0) {
                // ç§’æ€æˆåŠŸï¼Œè®°å½•ç”¨æˆ·è´­ä¹°çŠ¶æ€
                localStorage.setItem(purchaseKey, 'true');
                log(`ç§’æ€æˆåŠŸ - å·²è®°å½•è´­ä¹°çŠ¶æ€`);
                
                const resultElement = document.getElementById('testResult');
                resultElement.className = 'status success';
                resultElement.innerHTML = `
                    <strong>ğŸ‰ è´­ä¹°æˆåŠŸ</strong><br>
                    ${randomResponse.message}<br>
                    <small>å•†å“ID: ${productId} | ç”¨æˆ·ID: ${userId}</small><br>
                    <small>âš ï¸ ç°åœ¨å†æ¬¡è´­ä¹°æ­¤å•†å“å°†è¢«é˜»æ­¢</small>
                `;
                
                // è‡ªåŠ¨åˆ·æ–°è´­ä¹°è®°å½•
                setTimeout(showPurchaseHistory, 500);
                
                return randomResponse;
            } else {
                log(`è´­ä¹°å¤±è´¥: ${randomResponse.message}`);
                throw randomResponse;
            }
        }

        // æ˜¾ç¤ºè´­ä¹°è®°å½•
        function showPurchaseHistory() {
            const userId = getCurrentUserId();
            const products = [
                { id: 1001, name: 'iPhone 15 Pro Max' },
                { id: 1002, name: 'MacBook Pro 14è‹±å¯¸' },
                { id: 1003, name: 'iPad Pro 12.9è‹±å¯¸' }
            ];
            
            let historyHtml = `<strong>ç”¨æˆ· ${userId} çš„è´­ä¹°è®°å½•:</strong><br><br>`;
            let hasPurchases = false;
            
            products.forEach(product => {
                const purchaseKey = `purchase_${userId}_${product.id}`;
                const purchased = localStorage.getItem(purchaseKey) === 'true';
                const status = purchased ? 'âœ… å·²è´­ä¹°' : 'âŒ æœªè´­ä¹°';
                const statusClass = purchased ? 'color: #059669' : 'color: #6b7280';
                
                historyHtml += `<span style="${statusClass}">${status}</span> ${product.name} (ID: ${product.id})<br>`;
                
                if (purchased) {
                    hasPurchases = true;
                }
            });
            
            if (!hasPurchases) {
                historyHtml += '<br><em style="color: #6b7280;">æš‚æ— è´­ä¹°è®°å½•</em>';
            }
            
            document.getElementById('purchaseHistory').innerHTML = historyHtml;
            log('å·²åˆ·æ–°è´­ä¹°è®°å½•æ˜¾ç¤º');
        }

        // æ¸…é™¤æ‰€æœ‰è´­ä¹°è®°å½•
        function clearAllPurchases() {
            const userId = getCurrentUserId();
            const products = [1001, 1002, 1003];
            
            products.forEach(productId => {
                const purchaseKey = `purchase_${userId}_${productId}`;
                localStorage.removeItem(purchaseKey);
            });
            
            log('å·²æ¸…é™¤æ‰€æœ‰è´­ä¹°è®°å½•');
            showPurchaseHistory();
            
            const resultElement = document.getElementById('testResult');
            resultElement.className = 'status info';
            resultElement.innerHTML = 'âœ¨ è´­ä¹°è®°å½•å·²æ¸…é™¤ï¼Œç°åœ¨å¯ä»¥é‡æ–°æµ‹è¯•è´­ä¹°é€»è¾‘';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            showUserInfo();
            showPurchaseHistory();
            log('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
            log('');
            log('æµ‹è¯•æ­¥éª¤:');
            log('1. ç‚¹å‡»è´­ä¹°æŒ‰é’®æµ‹è¯•é¦–æ¬¡è´­ä¹°');
            log('2. å†æ¬¡ç‚¹å‡»ç›¸åŒå•†å“æµ‹è¯•é‡å¤è´­ä¹°é˜»æ­¢');
            log('3. æŸ¥çœ‹è´­ä¹°è®°å½•ç¡®è®¤çŠ¶æ€');
            log('4. æ¸…é™¤è®°å½•åå¯é‡æ–°æµ‹è¯•');
        });
    </script>
</body>
</html>
